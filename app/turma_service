"""
Servi√ßo para intera√ß√£o do usu√°rio via linha de comando com a entidade Turma
"""
import sys
import os

# Adicionar o diret√≥rio pai ao path para permitir imports
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from bd.database import DatabaseConnection
from dao.turma_dao import TurmaDAO
from model.turma import Turma


class TurmaService:

    def __init__(self, db: DatabaseConnection):
        self.db = db
        self.turmaDao = TurmaDAO(db)

    def exibirMenu(self):
        """Exibe o menu principal de op√ß√µes"""
        print("\n" + "="*50)
        print("  SISTEMA DE GERENCIAMENTO DE TURMAS ")
        print("="*50)
        print("1. Criar turma")
        print("2. Listar todas as turmas")
        print("3. Buscar turma por ID")
        print("4. Buscar turma por nome")
        print("5. Atualizar turma")
        print("6. Deletar turma")
        print("0. Sair")
        print("="*50)

    def criarTurma(self):
        """Solicita dados do usu√°rio e cria uma nova turma"""
        print("\n--- CRIAR CATEGORIA ---")
        nome = input("Digite o nome da turma: ").strip()

        if not nome:
            print("‚ùå Erro: O nome da turma n√£o pode ser vazio!")
            return

        try:
            # Verificar se j√° existe uma turma com esse nome
            turmaExistente = self.turmaDao.buscarPorNome(nome)
            if turmaExistente:
                print(f"‚ùå Erro: J√° existe uma turma com o nome '{nome}' (ID: {turmaExistente.id})")
                return

            # Criar nova turma
            turma = turma(id=None, nome=nome)
            turmaId = self.turmaDao.salvar(turma)
            print(f"‚úÖ Turma criada com sucesso!")
            print(f"   ID: {turmaId}")
            print(f"   Nome: {turma.nome}")

        except Exception as e:
            print(f"‚ùå Erro ao criar turma: {e}")

    def listarTurma(self):
        """Lista todas as turmas cadastradas"""
        print("\n--- LISTAR TODAS AS TURMAS ---")

        try:
            turmas = self.turmaDao.listarTodas()

            if not turmas:
                print("‚ö†Ô∏è  Nenhuma turma cadastrada.")
                return

            print(f"\nTotal de turmas: {len(turmas)}")
            print("\n" + "-"*50)
            print(f"{'ID':<5} | {'Nome':<30}")
            print("-"*50)

            for turma in turmas:
                print(f"{turma.id:<5} | {turma.nome:<30}")

            print("-"*50)

        except Exception as e:
            print(f"‚ùå Erro ao listar turmas: {e}")

    def buscarPorId(self):
        """Solicita um ID e busca a turma correspondente"""
        print("\n--- BUSCAR TURMA POR ID ---")

        try:
            idStr = input("Digite o ID da turma: ").strip()
            turmaId = int(idStr)

            turma = self.turmaDao.buscarPorId(turmaId)

            if turma:
                print("\n‚úÖ Turma encontrada:")
                print(f"   ID: {turma.id}")
                print(f"   Nome: {turma.nome}")
            else:
                print(f"‚ö†Ô∏è  Turma com ID {turmaId} n√£o encontrada.")

        except ValueError:
            print("‚ùå Erro: ID deve ser um n√∫mero inteiro!")
        except Exception as e:
            print(f"‚ùå Erro ao buscar turma: {e}")

    def buscarPorNome(self):
        """Solicita um nome e busca a turma correspondente"""
        print("\n--- BUSCAR TURMA POR NOME ---")

        nome = input("Digite o nome da turma: ").strip()

        if not nome:
            print("‚ùå Erro: O nome n√£o pode ser vazio!")
            return

        try:
            turma = self.turmaDao.buscarPorNome(nome)

            if turma:
                print("\n‚úÖ Turma encontrada:")
                print(f"   ID: {turma.id}")
                print(f"   Nome: {turma.nome}")
            else:
                print(f"‚ö†Ô∏è  Turma '{nome}' n√£o encontrada.")

        except Exception as e:
            print(f"‚ùå Erro ao buscar turma: {e}")

    def atualizarTurma(self):
        """Solicita dados do usu√°rio e atualiza uma turma existente"""
        print("\n--- ATUALIZAR TURMA ---")

        try:
            idStr = input("Digite o ID da turma a atualizar: ").strip()
            turmaId = int(idStr)

            # Buscar a turma existente
            turma = self.turmaDao.buscarPorId(turmaId)

            if not turma:
                print(f"‚ö†Ô∏è  Turma com ID {turmaId} n√£o encontrada.")
                return

            print(f"\nTurma atual:")
            print(f"   ID: {turma.id}")
            print(f"   Nome: {turma.nome}")

            novoNome = input("\nDigite o novo nome da turma (ou Enter para manter): ").strip()

            if not novoNome:
                print("‚ö†Ô∏è  Opera√ß√£o cancelada. Nome n√£o foi alterado.")
                return

            # Verificar se j√° existe outra turma com esse nome
            turmaExistente = self.turmaDao.buscarPorNome(novoNome)
            if turmaExistente and turmaExistente.id != turmaId:
                print(f"‚ùå Erro: J√° existe outra turma com o nome '{novoNome}' (ID: {turmaExistente.id})")
                return

            # Atualizar turma
            turma.nome = novoNome
            self.turmaDao.salvar(turma)
            print(f"\n‚úÖ Turma atualizada com sucesso!")
            print(f"   ID: {turma.id}")
            print(f"   Nome: {turma.nome}")

        except ValueError:
            print("‚ùå Erro: ID deve ser um n√∫mero inteiro!")
        except Exception as e:
            print(f"‚ùå Erro ao atualizar turma: {e}")

    def deletarTurma(self):
        """Solicita um ID e deleta a turma correspondente"""
        print("\n--- DELETAR TURMA ---")

        try:
            idStr = input("Digite o ID da turma a deletar: ").strip()
            turmaId = int(idStr)

            # Buscar a turma existente
            turma = self.turmaDao.buscarPorId(turmaId)

            if not turma:
                print(f"‚ö†Ô∏è  Turma com ID {turmaId} n√£o encontrada.")
                return

            print(f"\nTurma a ser deletada:")
            print(f"   ID: {turma.id}")
            print(f"   Nome: {turma.nome}")

            confirmacao = input("\n‚ö†Ô∏è  Tem certeza que deseja deletar esta turma? (s/N): ").strip().lower()

            if confirmacao != 's':
                print("‚ùå Opera√ß√£o cancelada.")
                return

            sucesso = self.turmaDao.deletar(turma)

            if sucesso:
                print(f"\n‚úÖ Turma deletada com sucesso!")
            else:
                print(f"\n‚ùå Erro ao deletar turma.")

        except ValueError:
            print("‚ùå Erro: ID deve ser um n√∫mero inteiro!")
        except Exception as e:
            print(f"‚ùå Erro ao deletar turma: {e}")

    def executar(self):
        """M√©todo principal que executa o loop do menu"""
        try:
            while True:
                self.exibirMenu()
                opcao = input("\nEscolha uma op√ß√£o: ").strip()

                if opcao == '0':
                    print("\nüëã Encerrando o sistema...")
                    break
                elif opcao == '1':
                    self.criarTurma()
                elif opcao == '2':
                    self.listarTurma()
                elif opcao == '3':
                    self.buscarPorId()
                elif opcao == '4':
                    self.buscarPorNome()
                elif opcao == '5':
                    self.atualizarTurma()
                elif opcao == '6':
                    self.deletarTurma()
                else:
                    print("‚ùå Op√ß√£o inv√°lida! Tente novamente.")

                input("\nPressione Enter para continuar...")

        except KeyboardInterrupt:
            print("\n\nüëã Sistema encerrado pelo usu√°rio.")
        except Exception as e:
            print(f"\n‚ùå Erro inesperado: {e}")
            import traceback
            traceback.print_exc()


def main():
    """Fun√ß√£o principal para executar o servi√ßo"""
    db = DatabaseConnection('exemplo_bd.db')

    try:
        # Conectar ao banco
        db.conectar()

        # Garantir que as tabelas existam
        db.criarTabelas()

        # Criar e executar o servi√ßo
        service = TurmaService(db)
        service.executar()

    except Exception as e:
        print(f"‚ùå Erro ao inicializar o sistema: {e}")
        import traceback
        traceback.print_exc()
    finally:
        db.fechar()
        print("‚úì Conex√£o com banco de dados encerrada.")


if __name__ == "__main__":
    main()